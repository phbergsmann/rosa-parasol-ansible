---
# Create a Kubernetes ServiceAccount and annotate it for IRSA (eks.amazonaws.com/role-arn)

- name: Wait for target namespace to exist
  ansible.builtin.command:
    cmd: oc get namespace {{ ocp4_workload_rosa_parasol_bedrock_irsa_namespace_kb }}
  register: ns_check
  retries: 30
  delay: 2
  until: ns_check.rc == 0
  changed_when: false

- name: Create temporary file
  ansible.builtin.tempfile:
    state: file
    suffix: yml
  register: ocp4_workload_rosa_parasol_bedrock_sa_tmp

- name: Render ServiceAccount manifest
  ansible.builtin.copy:
    dest: "{{ ocp4_workload_rosa_parasol_bedrock_sa_tmp.path }}"
    content: |
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: {{ ocp4_workload_rosa_parasol_bedrock_irsa_serviceaccount_kb }}
        namespace: {{ ocp4_workload_rosa_parasol_bedrock_irsa_namespace_kb }}
        annotations:
          eks.amazonaws.com/role-arn: "arn:aws:iam::{{ ocp4_workload_rosa_parasol_bedrock_aws_account_id }}:role/{{ ocp4_workload_rosa_parasol_bedrock_bedrock_create_kb_role }}"

- name: Apply ServiceAccount manifest
  ansible.builtin.command:
    cmd: >-
      oc apply -f {{ ocp4_workload_rosa_parasol_bedrock_sa_tmp.path }}
  register: sa_apply
  failed_when: sa_apply.rc != 0

- name: Remove generated manifest
  ansible.builtin.file:
    path: "{{ ocp4_workload_rosa_parasol_bedrock_sa_tmp.path }}"
    state: absent
  when: sa_apply is defined
