---
# Create a Kubernetes ServiceAccount and annotate it for IRSA (eks.amazonaws.com/role-arn)

- name: Render ServiceAccount manifest
  ansible.builtin.copy:
    dest: "{{ playbook_dir }}/.{{ ocp4_workload_rosa_parasol_bedrock_irsa_serviceaccount_kb }}.yaml"
    content: |
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: {{ ocp4_workload_rosa_parasol_bedrock_irsa_serviceaccount_kb }}
        namespace: {{ ocp4_workload_rosa_parasol_bedrock_irsa_namespace_kb }}
        annotations:
          eks.amazonaws.com/role-arn: "arn:aws:iam::{{ ocp4_workload_rosa_parasol_bedrock_aws_account_id }}:role/{{ ocp4_workload_rosa_parasol_bedrock_bedrock_create_kb_role }}"

- name: Apply ServiceAccount manifest
  ansible.builtin.command:
    cmd: >-
      oc apply -f {{ playbook_dir }}/.{{ ocp4_workload_rosa_parasol_bedrock_irsa_serviceaccount_kb }}.yaml
  register: sa_apply
  failed_when: sa_apply.rc != 0

- name: Remove generated manifest
  ansible.builtin.file:
    path: "{{ playbook_dir }}/.{{ ocp4_workload_rosa_parasol_bedrock_irsa_serviceaccount_kb }}.yaml"
    state: absent
  when: sa_apply is defined
